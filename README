{{Page security extension disclaimer}}
{{Extension|templatemode=
|name        = NSFileRepo
|status      = stable
|type1       = user rights
|type2       =
|hook1       = userCan
|hook2       = UploadForm:BeforeProcessing
|hook3       = ImgAuthBeforeStream
|username    = Jpond
|author      = Jack D. Pond, [[User:Osnard|Robert Vogel]]
|description = implements per-namespace group permissions for image and file rights protection
|image       =
|version     = 1.27
|update      = 2016-10-21
|mediawiki   = 1.27
|license     = GNU General Public Licence 2.0
|download    = {{WikimediaDownload|NSFileRepo}}
|readme      = [http://svn.wikimedia.org/svnroot/mediawiki/trunk/extensions/NSFileRepo/README README]
|changelog   = [http://svn.wikimedia.org/viewvc/mediawiki/trunk/extensions/NSFileRepo/?view=log log]
|parameters  = $wgWhitelistRead<br/>$wgImgAuthPublicTest<br/>$wgSpecialPageLockdown<br/>$wgActionLockdown<br/>$wgNamespacePermissionLockdown<br/>$wgExtraNamespaces<br/>$wgContentNamespaces<br/>$wgNonincludableNamespaces<br/>
|rights      = $wgGroupPermissions
|example     =
}}

The '''NSFileRepo''' restricts access to upload and read files and images to a given set of user groups associated with protected namespaces. Using this extension (within the security limitations noted above), you can protect not only pages and areas of your wiki, but also any uploaded images or files within those namespaces.

The purpose of this extension is to provide NameSpace-based features to uploaded files in the local file repositories (FileRepo)
The optimal solution would be a clean extension that is easily maintainable as the trunk of MW moves foward.

'''Namespaces''' are mechanism for grouping/separating wiki pages.

* See [[Help:Namespaces]] for more '''user help documentation''' on what they are and how they are used.
* See [[Manual:Namespace]] for '''system administration''' details on Mediawiki's namespace feature
* See [[Project:Namespaces]] for an explanation of how '''namespaces are used on mediawiki.org'''

__TOC__
==Usage==

Generically, you use the same syntax as a normal file/image reference link, adding the namespace between the file specifier ("File","Image", or "Media"), and the file name:

<pre>[[{FILE_NS}:{Namespace}:{Filename}]]</pre>

Example(Where "Project" is the protected namespace and "ProjectFile.pdf" is the file to which you wish to limit access):

<pre>[[File:Project:ProjectFile.pdf]]</pre>
<br>
The standard for accessing files/images is generally:
<pre>
[[File:Filename.txt]]
[[Image:Filename.jpg]]
[[Media:Filename.pdf]]
</pre>

This extension allows you to protect access to files/images, by adding the namespace text identifier after the file namespace identifier, for example(Where "Project" is the protected namespace and "ProjectFile.xxx" is the file to which you wish to limit access):
<pre>
[[File:Project:Filename.txt]]
[[Image:Project:Filename.jpg]]
[[Media:Project:Filename.pdf]]
</pre>

It may be helpful to understand the default security model used by MediaWiki using the instructions below:

* [[Manual:User rights]]
* [[Manual:$wgGroupPermissions]]

Limitations of security are the same as for Extension Lockdown.  To review these limitations, [[Extension:Lockdown#Additional_measures | please reference here]].

To use the full capabilities of this extension (e.g., specific namespace protections), you will need to install and use the namespace protections provided through [[Extension:Lockdown]].

This extension was made possible by the introduction of Repository Classes by Tim Starling - an elegant and brilliant implementation. It uses a new Local Repository class mechanism. Technical details on how this extension works can be found [[Extension:NSFileRepo/DOC | here]].

==Download instructions==

Copy all files and directories into directory:

<pre>
$IP/extensions/NSFileRepo
</pre>

==Installation==

You will need to read and understand two other required enhancements to MediaWiki:

* [[Manual:Image Authorization |Image Authorization]].
* [[Extension:Lockdown |Extension Lockdown]]

Please read and understand before executing the following instructions

# Download and install [[Extension:Lockdown | Extension Lockdown]].  If you have not installed
# Download and copy the NSFileRepo extension into directory <nowiki>$IP/extensions/NSFileRepo</nowiki>
# Activate the Image Authorization according to instructions found in [[Manual:Image Authorization | Image Authorization]]

== Activating NSFileRepo ==
# To activate this extension, add the following to [[Manual:LocalSettings.php|LocalSettings.php]]:
<source lang="php">
wfLoadExtension("NSFileRepo");
</source>

==Configuration parameters==

The user rights and configuration requiremements are are the same as described in [[Extension:Lockdown#Configuration | Extension Lockdown]].

== Release Notes ==

=== NSFileRepo 1.27.0 ===
* Compatibility to MediaWiki REL1_27
* Build upon <code>FileBackend</code> architecture by Aaron Schulz
* Added Special:Upload integration

=== NSFileRepo 1.7.0 ===
* Some refactoring, img_auth enabled by default

=== NSFileRepo 1.6.0 ===
* Migrated to JSON i18n files

=== NSFileRepo 1.5 ===
This is a major update to incorporate several evolved changes to the core FileRepo modules into the extension and to bring the extension up to current coding and core standards.  Specifically:

* [https://bugzilla.wikimedia.org/show_bug.cgi?id=45364 Bug Fix for 45364] - Fixed Move/Relocate issue and cleared result array for Title
* Synchronized with changes made to the core FileRepo classes and methods.  It now reflects fixes and upgrades as of 2013-2-27
* Updated for Documentation (doxygen)
* Cleared result array for userCan hook (NSFileRepolockdownUserCan) since Title now takes anything in that array to be an affirmative (user can)

Should be backwards compatible, but only tested with HEAD, 1.19 and 1.20

=== NSFileRepo 1.4 ===

* Bug Fixes - Thumbnails did not display properly in History (and even in uploads of past files).  The problem is fixed with 1.16 (and the current trunk version of NSFileRepo), but in versions of MW before 1.16, archived thumbnails still break because LocalFile.php uses hard-coded class of OldLocalFile instead of <nowiki>$repo->oldFileFactory</nowiki> which would instantiate the correct NSLocalFile class.

* Works with all namespaces > 1000 (used to only work with NS >=11 and <1000)

* Use NS_IMAGE instead of NS_FILE for backward compatibility

* Upgrades - Now works completely with >1.16.  Changes were made for 100% backward compatibility.  Even though it can be used all the way back to 1.13, the thumbnails probably will not display correctly because of issues with FileRepo before 1.16.  This is a cosmetic versus a functional issue - if it bothers you, just disable thumbnails.  If you're not using automatically generated thumbnails, you wouldn't notice the difference.

=== NSFileRepo 1.3 ===

* Allow files with namespace protection (e.g. File:ns:yourfile.txt) to be whitelisted using standard [[Manual:$wgWhitelistRead | $wgWhitelistRead]] in localsettings.

=== NSFileRepo 1.2 ===

* Fixed bug with reuploads and versioning
* Added protection to archived files and thumbs
* Known bug - deleted files are removed from protected Namespace and can be accessed - working on fix, but for now, recommend do not delete files.

=== NSFileRepo 1.1 ===

* First fully tested version, works with MW 1.13.1, 1.14.1, 1.15.1 with patches
* Works with 1.16.0 (trunk) without patches.

=== Tagged Releases ===
There were issues with image thumbnails that require modification to both NSFileRepo and the standard FileRepo.  These revisions have been tested for MW Rev 1.15.0 and should also work with 1.14.0.  It is doubtful they will work before 1.14.0.  If someone could test the 1.14.0 patches, I would be glad to assist in any issues you may have. --[[User:Jpond|jdpond]] 15:02, 13 May 2010 (UTC)

==== Tagged Release 1.14.0 Phase 3 ====

This tagged branch '''has not''' been tested.  It corrects the Thumbnail issues but requires:

* Replacement/patching of LocalFile.php
* Replacement/patching of GlobalFunctions.php
* Alternate branched versions of the core NSFileRepo code.

If you do not mind messed up thumbnails with problems in the following areas, you can stay with the HEAD version:

* Visual - displays broken impage link for thumbnails, especially in upload history
* Security - without this patch, it loads thumbnails into 'public' area which could (theoretically) be viewed regardless of NS protection

SVN available [http://svn.wikimedia.org/svnroot/mediawiki/tags/extensions/NSFileRepo/REL1_14_0/phase3 here]

==== Tagged Release 1.15.0 Phase 3 ====

This tagged branch '''has''' been tested.  It corrects the thumbnail issues but requires:

* Replacement/patching of LocalFile.php
* Replacement/patching of GlobalFunctions.php
* Alternate branched versions of the core NSFileRepo code.

If you do not mind messed up thumbnails with problems in the following areas, you can stay with the HEAD version:

* Visual - displays broken impage link for thumbnails, especially in upload history
* Security - without this patch, it loads thumbnails into 'public' area which could (theoretically) be viewed regardless of NS protection

SVN available [http://svn.wikimedia.org/svnroot/mediawiki/tags/extensions/NSFileRepo/REL1_15_0/phase3 here]

==See also==

* [[Manual:Image Authorization | Image Authorization]].
* [[Extension:Lockdown | Extension Lockdown]]

[[Category:View page extensions]]
[[Category:Edit extensions]]
[[Category:Namespace extensions]]
{{languages}}